# Check typing, as tsx does not check typing.
echo "--------- Checking Typescript ---------"
npx tsc --noEmit --project tsconfig.test-included.json

echo "✅ Typing is ok."

# Generate config, making sure it is up-to-date
echo "--------- Generating server and plugin config ---------"
npm run generate-config -- --force

# Check for unstaged changes in tracked files
if [ -n "$(git diff --name-only)" ]; then
  echo "⚠️  Unstaged changes in tracked files detected! Please stage these changes before committing."
  echo "⚠️  Run 'git add <files>' to stage, and then try committing again."
  exit 1
fi

# Check for untracked files that are not staged
if [ -n "$(git ls-files --others --exclude-standard)" ]; then
  echo "⚠️  Untracked files detected! Please stage new files before committing."
  echo "⚠️  Run 'git add <files>' to stage, and then try committing again."
  exit 1
fi

echo "✅ Config is up-to-date."

# Eslint and prettier
echo "--------- Prettier and eslint ---------"
npx lint-staged --config lint-staged.config.js

# echo "✅ todo."


# Run tests
echo "--------- Unit and e2e tests ---------"
npx vitest --run --silent

echo "✅ Tests are ok."
